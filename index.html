<!DOCTYPE html>
<html lang="en">

<head>
    <title>PuePy Demo</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="stylesheet" href="./dist/styles.css">
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.2.2/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.2.2/core.js"></script>
    <script type="module">
        // OPFS helpers with top-level await to preload initial state
        // Accept JSON string to avoid Python<->JS proxy conversion issues
        async function saveState(stateJson) {
            try {
                const root = await navigator.storage.getDirectory();
                const fileHandle = await root.getFileHandle('state.json', { create: true });
                const writable = await fileHandle.createWritable();
                const payload = typeof stateJson === 'string' ? stateJson : JSON.stringify(stateJson);
                await writable.write(new Blob([payload], { type: 'application/json' }));
                await writable.close();
                return true;
            } catch (e) {
                console.warn('saveState failed', e);
                return false;
            }
        }

        async function loadState() {
            try {
                const root = await navigator.storage.getDirectory();
                const fileHandle = await root.getFileHandle('state.json');
                const file = await fileHandle.getFile();
                const text = await file.text();
                return JSON.parse(text);
            } catch (e) {
                return null;
            }
        }

        const __INITIAL_STATE__ = await loadState();
        // Expose as plain string to simplify Python side
        window.__INITIAL_STATE__ = __INITIAL_STATE__ ? JSON.stringify(__INITIAL_STATE__) : "";
        window.__opfs__ = { saveState, loadState };

        // Confetti setup
        import confetti from './dist/confetti.module.mjs';
        const canvas = document.createElement('canvas');
        canvas.id = 'confetti-canvas';
        canvas.style.position = 'fixed';
        canvas.style.pointerEvents = 'none';
        canvas.style.top = '0';
        canvas.style.left = '0';
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        document.body.appendChild(canvas);

        const conf = confetti.create(canvas, { resize: true, useWorker: false });
        window.__confetti__ = conf;
    </script>
</head>

<body class="min-h-screen max-w-4xl mx-auto px-4" style="background-color: var(--catppuccin-base); color: var(--catppuccin-text); width: 100%; box-sizing: border-box;">
    <div id="app" class="min-h-screen">
        <div class="flex justify-center items-center min-h-screen">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2" style="border-color: var(--catppuccin-mauve);"></div>
        </div>
    </div>
    <script type="mpy" src="./hello_world.py" config="./pyscript.json"></script>
</body>

</html>